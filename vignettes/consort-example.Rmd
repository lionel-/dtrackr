---
title: "Dtrackr - Consort statement example"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Dtrackr - Consort statement example}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
bibliography: dtrackr.bib
csl: dtrackr.csl
---

# Consort statement

Consort diagrams are part of some clinical trial or observational study check lists. They clarify how the data was handled, what stratification was done. This vignette is incomplete. 
Cite data sets [@ramanaCriticalComparativeStudy; @ramanaCriticalStudySelected2011; @Dua2019]

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)

options(warn=1)
```

```{r setup}
library(tidyverse)
library(dtrackr)

```

In this example we look at the Indian liver patients data set. This has some clinical data on patients and we pretend we are conducting an observational study on liver disease patients.

* They must match the criteria for entry which in this example is having a total bilirubin >= 0.7 for women or >= 0.8 for men.
* They must be adults aged between the ages of 18 and 80 inclusive.

This can be coded into the `dplyr` pipeline and a flowchart stratified by case or control status generated:

```{r}
options(dtrackr.strata_glue="{tolower(.value)}")
options(dtrackr.strata_sep=", ")
options(dtrackr.default_message = "{.count} patients")
options(dtrackr.default_headline = NULL)

ilpd = dtrackr::ILPD %>% 
  track() %>%
  capture_exclusions() %>%
  include_any(
    Gender == "Female" & Total_Bilirubin >= 0.7 ~ "{.included} women with bili>0.7",
    Gender == "Male" & Total_Bilirubin >= 0.8 ~ "{.included} men with bili>0.8"
  ) %>%
  group_by(Case_or_Control, .messages="cases versus controls") %>%
  comment() %>%
  exclude_all(
    Age<18 ~ "{.excluded} subjects under 18",
    Age>80 ~ "{.excluded} subjects over 80"
  ) %>%
  comment(.messages = "{.count} after exclusions") %>%
  status(
    mean_bili = sprintf("%1.2f \u00B1 %1.2f",mean(Total_Bilirubin),sd(Total_Protein)),
    mean_alb = sprintf("%1.2f \u00B1 %1.2f",mean(Albumin),sd(Albumin)),
    .messages = c(
      "bilirubin: {mean_bili}",
      "albumin: {mean_alb}"
    )                    
  ) %>%
  ungroup(.messages = "{.count} in final data set")

ilpd %>% flowchart()

```

With a bit of experimentation the flowchart needed for a Consort statement can be generated. One option to output the flowchart is SVG which can then be manually formatted as required.

# Excluded data

During this pipeline, we may be keen to understand why certain data items are being rejected. This would enable us to examine the source data, and potentially correct it during the data collection process. We've used it to allow continuous quality checks on the data to feed back to the data curators, as we regularly conduct analyses. By tracking the exclusions, not only do we track the data flow through the pipeline we also retain all excluded items, with the reason for exclusion. Thus we can reassure ourselves that the exclusions are as expected. We enabled this by calling `capture_exclusions()` in the pipeline above. Having tracked the exclusions we can retrieve them by calling `excluded()` which gives a data frame with the excluded records and the reasons. If the exclusions happened over multiple stages as the dataframe format change in between then this will be held as a nested dataframe (i.e. see `?tidyr::nest`):

```{r}

# here we filter out the majority of the actual content of the excluded data to focus on the 
# metadata recovered during the exclusion.
ilpd %>% excluded() %>% select(.stage,.message,.filter,Age, Gender)


```

This list may have multiple entries for a single data item, if for example something is excluded in any one step for many reasons.

<div id="refs"></div>
