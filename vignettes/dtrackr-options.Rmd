---
title: "Dtrackr configuration"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Dtrackr - configuration example}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include=FALSE}
library(tidyverse)
library(dtrackr)

knitr::opts_chunk$set(echo = TRUE)
options(dtrackr.strata_glue=NULL)
options(dtrackr.strata_sep=NULL)
options(dtrackr.default_message=NULL)
options(dtrackr.default_headline=NULL)

```

# Global configuration

Most of the behaviour of `dtrackr` can be specified at the individual call level using the `.headline` and `.messages` glue specifications to define a format. Sometimes however this is annoying to do for all the stages in a flow chart and a global configuration of behaviour is desirable.

## Naming conventions for groups

One of the areas where default behaviour may be undesirable is the naming of groups. The default setting combines the group name `{.group}` and the group value `{.value}` into a concatenated colon separated string as demonstrated below:

```{r}

# these are the defaults
options(dtrackr.strata_glue="{.group}:{.value}")
options(dtrackr.strata_sep="; ")

dtrackr::ILPD %>%
  track() %>%
  group_by(Case_or_Control) %>%
  comment() %>%
  group_by(Gender,.add = TRUE) %>%
  comment(
    .messages = c(
    "{.count} patients",
    "{sprintf('%1.0f',.count/.total*100)}% of the total")) %>%
  ungroup() %>%
  flowchart()
```

In particular in situations like this where you are faceting on factors or strings, disposing of the group name may make this clearer. In the following example we only include the group value, force it to lower case, and use a comma to separate multiple facets. We have used manual override of the messages in the grouping stages to specify what we are faceting by in a more natural way:

```{r}

# only include the group value in the description of the group
options(dtrackr.strata_glue="{tolower(.value)}")
options(dtrackr.strata_sep=", ")

dtrackr::ILPD %>%
  track() %>%
  group_by(
    Case_or_Control,
    .messages = "case or control"
  ) %>%
  comment() %>%
  group_by(
    Gender,
    .add = TRUE, 
    .messages = "by {tolower(.cols)}" #.cols contains a csv string of the grouping variables
  ) %>%
  comment(
    .messages = c(
    "{.count} patients",
    "{sprintf('%1.0f',.count/.total*100)}% of the total")) %>%
  ungroup() %>%
  flowchart()

```

N.B. this setting affects the "strata" label of the group, which in turn affects the flowchart branching. If this is not unique from one group to another strange behaviours will be observed.

## Default text

With the group strata label defined you can set other defaults. In the flowchart above the "583 items" labels are generated by the default message setting, and the headings for the groups by the default headline setting. In this example we change these to alter the default text.

```{r}

options(dtrackr.strata_glue="{tolower(.value)}")
options(dtrackr.strata_sep=", ")
options(dtrackr.default_message = "containing {.count} patients")
options(dtrackr.default_headline = "subgroup: {.strata}")


dtrackr::ILPD %>%
  track() %>%
  group_by(
    Case_or_Control,
    .messages = "case or control"
  ) %>%
  comment() %>%
  group_by(
    Gender,
    .add = TRUE, 
    .messages = "by gender"
  ) %>%
  comment(
    .messages = c(
    "{.count} patients",
    "{sprintf('%1.0f',.count/.total*100)}% of the total")) %>%
  ungroup() %>%
  flowchart()

# N.b. this setting includes some unwanted headlines in the ungrouped stages of the flow chart. If a headline evaluates to "" then the headline is suppressed and we can get rid of unwanted headlines. An example of doing this is as follows:
# options(dtrackr.default_headline = "{ifelse(.strata != '', glue::glue('subgroup: {.strata}'), '')}")
```

## Excluisions

Elsewhere we discuss the possibility of capturing excluded items for debugging. This behaviour can be added to any pipeline with the `capture_exclusions()` function. Alternatively it can be globally enabled with the following option. Usual caveats about performance apply.

```{r}
options(dtrackr.exclusions=TRUE)
```

## Reporting exclusions which do nothing

```{r}
options(dtrackr.show_zero_exclusions=FALSE)
```

## Future work

There are a wide range of other pieces of default text which we would like to be able to configure on a global level. These can already be tweaked at the level of an individual flowchart but it would be helpful to allow more global configuration. 
